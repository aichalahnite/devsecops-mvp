<!DOCTYPE html>
<html>
<head>
    <title>DevSecOps Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
<div class="container">

    <h1>üöÄ DevSecOps Security Scanner</h1>

    <form id="scanForm">
        <input type="file" name="file" id="fileInput" required>
        <button type="submit" id="scanBtn">Start Scan</button>
        <button type="button" id="cancelBtn" class="danger" disabled>Cancel</button>
    </form>

    <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div id="statusBox"></div>
    <div id="scoreBox"></div>
    <div id="results"></div>
    <div id="downloadSection" style="display: none;">
        <button id="downloadPdfBtn" class="primary">Download PDF Report</button>
    </div>

</div>

<script>
const form = document.getElementById("scanForm");
const scanBtn = document.getElementById("scanBtn");
const cancelBtn = document.getElementById("cancelBtn");
const progressBar = document.getElementById("progressBar");
const statusBox = document.getElementById("statusBox");
const resultsDiv = document.getElementById("results");
const scoreBox = document.getElementById("scoreBox");
const downloadSection = document.getElementById("downloadSection");
const downloadPdfBtn = document.getElementById("downloadPdfBtn");

let scanId = null;
let polling = null;

form.addEventListener("submit", async (e) => {
    e.preventDefault();

    scanBtn.disabled = true;
    cancelBtn.disabled = false;
    scanBtn.textContent = "Scanning...";
    resultsDiv.innerHTML = "";
    scoreBox.innerHTML = "";
    progressBar.style.width = "0%";

    const formData = new FormData(form);

    const res = await fetch("/scan", {
        method: "POST",
        body: formData
    });

    const data = await res.json();
    scanId = data.scan_id;
    startPolling();
});

cancelBtn.addEventListener("click", async () => {
    if (!scanId) return;

    await fetch(`/cancel/${scanId}`, { method: "POST" });

    cancelBtn.disabled = true;
    scanBtn.disabled = false;
    scanBtn.textContent = "Start Scan";

    statusBox.innerHTML = "<span class='error'>Scan Cancelled</span>";
    clearInterval(polling);
});

function startPolling() {
    polling = setInterval(async () => {

        const res = await fetch(`/scan-status/${scanId}`);
        const data = await res.json();

        progressBar.style.width = data.progress + "%";

        statusBox.innerHTML = `
            <div class="status">
                <strong>Current Step:</strong> ${data.current}
                <br>
                <strong>Total Time:</strong> ‚è± ${data.total_duration || 0}s
            </div>
        `;

        if (data.score !== null) {
            scoreBox.innerHTML = `
                <div class="score">
                    Security Score:
                    <span class="${getScoreClass(data.score)}">
                        ${data.score}/100
                    </span>
                </div>
            `;
        }

        resultsDiv.innerHTML = "";

        for (const [name, step] of Object.entries(data.steps)) {

            const block = document.createElement("details");

            block.innerHTML = `
                <summary>
                    <div class="summary-left">
                        <span class="tool-name">${name.toUpperCase()}</span>
                        <span class="status-badge ${step.status}">
                            ${step.status}
                        </span>
                    </div>
                    <div class="summary-right">
                        ‚è± ${step.duration || 0}s
                    </div>
                </summary>
                <pre>${step.result ? JSON.stringify(step.result, null, 2) : ""}</pre>
            `;

            resultsDiv.appendChild(block);
        }

        if (data.current === "finished" || data.current === "failed" || data.current === "cancelled") {
            clearInterval(polling);
            scanBtn.disabled = false;
            cancelBtn.disabled = true;
            scanBtn.textContent = "Start Scan";

            if (data.current === "finished") {
                downloadSection.style.display = "block";
            }
        }

    }, 1500);
}

downloadPdfBtn.addEventListener("click", () => {
    if (!scanId) return;

    const link = document.createElement("a");
    link.href = `/download-pdf/${scanId}`;
    link.download = `security-scan-${scanId}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});

function getScoreClass(score) {
    if (score >= 80) return "good";
    if (score >= 50) return "medium";
    return "bad";
}
</script>

</body>
</html>
